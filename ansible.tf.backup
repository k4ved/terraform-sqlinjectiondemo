resource "null_resource" "ConfigureAnsibleLabelVariable" {
  provisioner "local-exec" {
    command = "echo [${var.dev_host_label}:vars] > ansible/hosts"
  }
  provisioner "local-exec" {
    command = "echo ansible_ssh_user=${var.ssh_user_name} >> ansible/hosts"
  }
  provisioner "local-exec" {
    command = "echo ansible_ssh_private_key_file=${var.ssh_key_path} >> ansible/hosts"
  }
  provisioner "local-exec" {
    command = "echo ansible_ssh_common_args='-o StrictHostKeyChecking=no' >> ansible/hosts"
  }
  provisioner "local-exec" {
    command = "echo [${var.dev_host_label}] >> ansible/hosts"
  }
}
resource "null_resource" "ProvisionRemoteHostsIpToAnsibleHosts" {
  connection {
    type = "ssh"
    user = "${var.ssh_user_name}"
    host = "${aws_instance.injection_demo.public_ip}"
    private_key = "${file("${var.ssh_key_path}")}"
  }
  provisioner "local-exec" {
    command = "echo ${aws_instance.injection_demo.public_ip} >> ansible/hosts"
  }
}

resource "null_resource" "ModifyApplyAnsiblePlayBook" {

  provisioner "local-exec" {
    command = "sleep 120; cd ansible; ansible-playbook -i hosts play.yml"
  }
  depends_on = [null_resource.ProvisionRemoteHostsIpToAnsibleHosts]
}
